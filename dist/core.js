!function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t){e.exports=require("routing-controllers")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(14);const a=r(15).default;t.default=a},function(e,t,r){"use strict";function a(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0}),a(r(17)),a(r(28))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(19))},function(e,t){e.exports=require("axios")},function(e,t,r){"use strict";function a(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0}),a(r(23)),a(r(25))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(24),n=r(1);switch(n.default.NAME){case"development":case"production":a.connect(`mongodb://${n.default.DBHOST}:${n.default.DBPORT}/${n.default.DBNAME}`,{useNewUrlParser:!0}).then().catch(e=>console.log(e))}a.connection.once("error",e=>console.error(`mongodb connect error:\n${e}`)).once("open",()=>{console.log("mongodb connect success")}),t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(8),n=r(1);(async()=>{try{(await a.createHttpServer()).listen(n.default.PORT,async()=>{console.log(`Server is listening on ${n.default.PORT}`)})}catch(e){console.log(e)}})()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(9);t.createHttpServer=a.default},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const a=r(10),n=r(11),s=r(12);r(13);const o=r(0),i=r(1),u=r(16),c=r(30);t.default=(async()=>{const t=new a;return t.use(n(e+"/../dashboard/build",{maxAge:"production"===i.default.NAME?s("20d"):0})),t.use(n(e+"/../core/export")),o.useKoaServer(t,{routePrefix:"/api",controllers:[u.default,c.default],classTransformer:!1}),t})}).call(this,"src/http")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("ms")},function(e,t){e.exports=require("reflect-metadata")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={NAME:"development",PORT:9998,DBHOST:"localhost",DBPORT:27017,DBNAME:"fxxkSpider"}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={NAME:"production",PORT:9998,DBHOST:"localhost",DBPORT:27017,DBNAME:"fxxkSpider"}},function(e,t,r){"use strict";var a=this&&this.__decorate||function(e,t,r,a){var n,s=arguments.length,o=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,a);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(o=(s<3?n(o):s>3?n(t,r,o):n(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,a){t(r,a,e)}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(0),i=r(2);let u=class{async createTask(e,t,r){return await i.getGoodsListFromPage(e,t,r)}async getTask(e){return await i.getTask(e)}async exportTaskResult(e){return await i.taskResultExport(e)}async getTaskList(){return await i.getTaskList()}};a([o.Post("/task"),s(0,o.BodyParam("gameName",{required:!0})),s(1,o.BodyParam("startPage",{required:!0})),s(2,o.BodyParam("endPage",{required:!0})),n("design:type",Function),n("design:paramtypes",[String,Number,Number]),n("design:returntype",Promise)],u.prototype,"createTask",null),a([o.Get("/task/:id"),s(0,o.Param("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getTask",null),a([o.Get("/task/:id/export"),s(0,o.Param("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"exportTaskResult",null),a([o.Get("/task"),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],u.prototype,"getTaskList",null),u=a([o.JsonController()],u),t.default=u},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const a=r(18),n=r(3),s=r(5),o=r(26),i=r(27);t.getGoodsListFromPage=(async(e="csgo",t=1,r)=>{const o=`于${a().format("YYYY-MM-DD, h:mm:ss a")}创建的爬取${e}，从第${t}页到第${-1===r?"最后一":r}页的任务单`,i=await s.Task.create({desc:o});let u=[];try{(async()=>{let t=1;await n.getGoodsList(e,t);for(;t<=r||-1===r;t++){const a=await n.getGoodsList(e,t);-1===r&&(r=a.data.total_page),console.log(t,a.data.items.length),u=[...u,...a.data.items.filter(e=>Number(e.sell_min_price)>=2&&Number(e.sell_min_price)<=3e3)]}const a=JSON.stringify(n.parseGoodsList(u)),o=`${((new Date).getTime()-new Date(i.createdAt).getTime())/1e3}s`;await i.update({status:s.Status.success,rawResult:a,timeConsuming:o})})()}catch(e){await i.update({status:s.Status.fail})}return{error:0,msg:"成功",data:i}}),t.getTask=(async e=>await s.Task.findOne({_id:e},"-rawResult")),t.getTaskList=(async()=>{try{return await s.Task.find({},"-rawResult").sort("-createdAt")}catch(e){return await s.Task.remove({}),await s.Task.find({},"-rawResult").sort("-createdAt")}}),t.taskResultExport=(async t=>{const r=await s.Task.findOne({_id:t}),a=new o.File,n=a.addSheet("DefaultSheet"),u=n.addRow();u.addCell().value="商品名",u.addCell().value="Buff出售最低价（单位：元）",u.addCell().value="steam出售价格（单位：元）",u.addCell().value="倍数",u.addCell().value="Buff在售数量",u.addCell().value="原始折扣价（百分比）",u.addCell().value="原始转回利润（百分比）",u.addCell().value="Buff商品链接",u.addCell().value="steam商品链接",JSON.parse(r.rawResult).forEach(e=>{const t=n.addRow(),r=t.addCell(),a=t.addCell(),s=t.addCell(),o=t.addCell(),i=t.addCell(),u=t.addCell(),c=t.addCell(),l=t.addCell(),d=t.addCell();r.value=e.name,a.value=e.sell_min_price,s.value=e.steam_price_cny,o.value=e.diff_price,i.value=e.sell_num,u.value=e.original_discount_price,c.value=e.original_profit,l.value=e.buff_goods_url,d.value=e.steam_market_url});const c=`${1e6*Math.random()}.xlsx`;return a.saveAs().pipe(i.createWriteStream(e+`/../export/${c}`)),await r.update({resultUrl:c}),{error:0,msg:"成功",data:{}}})}).call(this,"src/core/apis")},function(e,t){e.exports=require("moment")},function(e,t,r){"use strict";function a(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0}),a(r(20)),a(r(22))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(4),n=r(21);t.getGoodsList=(async(e,t)=>{return(await a.default.get(`https://buff.163.com/api/market/goods?game=${e}&page_num=${t}&page_size=1000`)).data}),t.getGoodsBillOrder=(async(e,t)=>{return(await a.default.get(`https://buff.163.com/api/market/goods/bill_order?game=${e}&goods_id=${t}`)).data}),t.parseGoodsList=(e=>e.map(e=>({id:e.id,name:e.name,market_hash_name:e.market_hash_name,sell_min_price:e.sell_min_price,sell_num:e.sell_num,steam_market_url:e.steam_market_url,icon_url:e.goods_info.icon_url,steam_price:e.goods_info.steam_price,steam_price_cny:e.goods_info.steam_price_cny,diff_price:n.eval(`${e.sell_min_price} / ${e.goods_info.steam_price_cny}`),original_discount_price:n.eval(`${e.sell_min_price} * 1.15 / ${e.goods_info.steam_price_cny} * 100`),original_profit:n.eval(`((${e.sell_min_price} * ${1-("dota2"===e.game?.018:.025)} - ${e.goods_info.steam_price_cny} * 0.82) / ${e.goods_info.steam_price_cny} * 0.82) * 100`),buff_goods_url:`https://buff.163.com/market/goods?goods_id=${e.id}`})))},function(e,t){e.exports=require("mathjs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(4);t.getSteamPriceOverview=(async(e,t)=>{let r;switch(e){case"dota2":case"csgo":r=570;break;case"pubg":r=578080;break;default:return{status:!1}}const n=await a.default.get(`https://steamcommunity.com/market/priceoverview/?country=CN&currency=23&appid=${r}&market_hash_name=${encodeURI(t)}`);return!!n.data.success&&n.data})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(6),{Schema:n}=a.default;var s;!function(e){e[e.pending=-1]="pending",e[e.fail=0]="fail",e[e.success=1]="success"}(s||(s={})),t.StatusType=s;t.Status={pending:-1,fail:0,success:1};const o=new n({status:{type:Number,required:!0,default:s.pending},resultUrl:{type:String,required:!1},rawResult:{type:String,required:!1},desc:{type:String,required:!0},timeConsuming:{type:String,required:!1}},{timestamps:!0}),i=a.default.model("Task",o);t.Task=i},function(e,t){e.exports=require("mongoose")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(6),{Schema:n}=a.default;var s;!function(e){e[e.pending=-1]="pending",e[e.fail=0]="fail",e[e.success=1]="success"}(s||(s={}));const o=new n({marketHashName:{type:String,required:!0},gameName:{type:String,required:!0},intervals:{type:Number,required:!0,default:60},status:{type:Number,required:!0,default:s.pending},lowestPrice:{type:String,required:!1},volume:{type:String,required:!1},medianPrice:{type:String,required:!1}},{timestamps:!0}),i=a.default.model("Subscriber",o);t.Subscriber=i},function(e,t){e.exports=require("better-xlsx")},function(e,t){e.exports=require("fs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(5),n=r(29),s=r(3),o=async(e,t,r)=>{const n=await s.getSteamPriceOverview(t,r);n?await e.update({status:a.Status.success,lowestPrice:n.lowest_price,volume:n.volume,medianPrice:n.median_price}):await e.update({status:a.Status.fail})};t.initSubscriber=(async(e,t,r)=>{const s=await a.Subscriber.create({marketHashName:t,gameName:e,intervals:r});o(s,e,t);const i=n.scheduleJob(`*/${r} * * * *`,function(r){console.log("Subscriber subscribing"),console.log(i.nextInvocation()),o(r,e,t)}.bind(null,s));return{error:0,msg:"成功",data:s}})},function(e,t){e.exports=require("node-schedule")},function(e,t,r){"use strict";var a=this&&this.__decorate||function(e,t,r,a){var n,s=arguments.length,o=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,a);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(o=(s<3?n(o):s>3?n(t,r,o):n(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,a){t(r,a,e)}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(0),i=r(2);let u=class{async createSubscriber(e,t,r){return await i.initSubscriber(e,t,r)}};a([o.Post("/subscribe"),s(0,o.BodyParam("gameName",{required:!0})),s(1,o.BodyParam("marketHashName",{required:!0})),s(2,o.BodyParam("intervals",{required:!0})),n("design:type",Function),n("design:paramtypes",[String,String,Number]),n("design:returntype",Promise)],u.prototype,"createSubscriber",null),u=a([o.JsonController()],u),t.default=u}]);