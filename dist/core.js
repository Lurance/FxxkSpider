!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(9);const n=r(10).default;t.default=n},function(e,t){e.exports=require("routing-controllers")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(3),a=r(0);(async()=>{try{(await n.createHttpServer()).listen(a.default.PORT,async()=>{console.log(`Server is listening on ${a.default.PORT}`)})}catch(e){console.log(e)}})()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(4);t.createHttpServer=n.default},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const n=r(5),a=r(6),o=r(7);r(8);const s=r(1),i=r(0),u=r(11);t.default=(async()=>{const t=new n;return t.use(a(e+"/../dashboard/build",{maxAge:"production"===i.default.NAME?o("20d"):0})),t.use(a(e+"/../core/export")),s.useKoaServer(t,{routePrefix:"/api",controllers:[u.default],classTransformer:!1}),t})}).call(this,"src/http")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("ms")},function(e,t){e.exports=require("reflect-metadata")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={NAME:"development",PORT:9998,DBHOST:"localhost",DBPORT:27017,DBNAME:"fxxkSpider"}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={NAME:"production",PORT:9998,DBHOST:"localhost",DBPORT:27017,DBNAME:"fxxkSpider"}},function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var a,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var i=e.length-1;i>=0;i--)(a=e[i])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},a=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(1),i=r(12);let u=class{async createTask(e,t,r){return await i.getGoodsListFromPage(e,t,r)}async getTask(e){return await i.getTask(e)}async exportTaskResult(e){return await i.taskResultExport(e)}async getTaskList(){return await i.getTaskList()}};n([s.Post("/task"),o(0,s.BodyParam("gameName",{required:!0})),o(1,s.BodyParam("startPage",{required:!0})),o(2,s.BodyParam("endPage",{required:!0})),a("design:type",Function),a("design:paramtypes",[String,Number,Number]),a("design:returntype",Promise)],u.prototype,"createTask",null),n([s.Get("/task/:id"),o(0,s.Param("id")),a("design:type",Function),a("design:paramtypes",[String]),a("design:returntype",Promise)],u.prototype,"getTask",null),n([s.Get("/task/:id/export"),o(0,s.Param("id")),a("design:type",Function),a("design:paramtypes",[String]),a("design:returntype",Promise)],u.prototype,"exportTaskResult",null),n([s.Get("/task"),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",Promise)],u.prototype,"getTaskList",null),u=n([s.JsonController()],u),t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(13))},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const n=r(14),a=r(15),o=r(20),s=r(24),i=r(25);t.getGoodsListFromPage=(async(e="csgo",t=1,r)=>{const s=`于${n().format("YYYY-MM-DD, h:mm:ss a")}创建的爬取${e}，从第${t}页到第${-1===r?"最后一":r}页的任务单`,i=await o.Task.create({desc:s});let u=[];try{(async()=>{let t=1;await a.getGoodsList(e,t);for(;t<=r||-1===r;t++){const n=await a.getGoodsList(e,t);-1===r&&(r=n.data.total_page),console.log(t,n.data.items.length),u=[...u,...n.data.items.filter(e=>Number(e.sell_min_price)>=2&&Number(e.sell_min_price)<=3e3)]}const n=JSON.stringify(a.parseGoodsList(u)),s=`${((new Date).getTime()-new Date(i.createdAt).getTime())/1e3}s`;await i.update({status:o.Status.success,rawResult:n,timeConsuming:s})})()}catch(e){await i.update({status:o.Status.fail})}return{error:0,msg:"成功",data:i}}),t.getTask=(async e=>await o.Task.findOne({_id:e},"-rawResult")),t.getTaskList=(async()=>{try{return await o.Task.find({},"-rawResult").sort("-createdAt")}catch(e){return await o.Task.remove({}),await o.Task.find({},"-rawResult").sort("-createdAt")}}),t.taskResultExport=(async t=>{const r=await o.Task.findOne({_id:t}),n=new s.File,a=n.addSheet("DefaultSheet"),u=a.addRow();u.addCell().value="商品名",u.addCell().value="Buff出售最低价（单位：元）",u.addCell().value="steam出售价格（单位：元）",u.addCell().value="倍数",u.addCell().value="Buff在售数量",u.addCell().value="原始折扣价（百分比）",u.addCell().value="原始转回利润（百分比）",u.addCell().value="Buff商品链接",JSON.parse(r.rawResult).forEach(e=>{const t=a.addRow(),r=t.addCell(),n=t.addCell(),o=t.addCell(),s=t.addCell(),i=t.addCell(),u=t.addCell(),l=t.addCell(),c=t.addCell();r.value=e.name,n.value=e.sell_min_price,o.value=e.steam_price_cny,s.value=e.diff_price,i.value=e.sell_num,u.value=e.original_discount_price,l.value=e.original_profit,c.value=e.buff_goods_url});const l=`${1e6*Math.random()}.xlsx`;return n.saveAs().pipe(i.createWriteStream(e+`/../export/${l}`)),await r.update({resultUrl:l}),{error:0,msg:"成功",data:{}}})}).call(this,"src/core/apis")},function(e,t){e.exports=require("moment")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(16))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(17))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(18),a=r(19);t.getGoodsList=(async(e,t)=>{return(await n.default.get(`https://buff.163.com/api/market/goods?game=${e}&page_num=${t}&page_size=1000`)).data}),t.getGoodsBillOrder=(async(e,t)=>{return(await n.default.get(`https://buff.163.com/api/market/goods/bill_order?game=${e}&goods_id=${t}`)).data}),t.parseGoodsList=(e=>e.map(e=>({id:e.id,name:e.name,sell_min_price:e.sell_min_price,sell_num:e.sell_num,steam_market_url:e.steam_market_url,icon_url:e.goods_info.icon_url,steam_price:e.goods_info.steam_price,steam_price_cny:e.goods_info.steam_price_cny,diff_price:a.eval(`${e.sell_min_price} / ${e.goods_info.steam_price_cny}`),original_discount_price:a.eval(`${e.sell_min_price} * 1.15 / ${e.goods_info.steam_price_cny} * 100`),original_profit:a.eval(`((${e.sell_min_price} * ${1-("dota2"===e.game?.018:.025)} - ${e.goods_info.steam_price_cny} * 0.82) / ${e.goods_info.steam_price_cny} * 0.82) * 100`),buff_goods_url:`https://buff.163.com/market/goods?goods_id=${e.id}`})))},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("mathjs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(21))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(22),{Schema:a}=n.default;var o;!function(e){e[e.pending=-1]="pending",e[e.fail=0]="fail",e[e.success=1]="success"}(o||(o={})),t.StatusType=o;t.Status={pending:-1,fail:0,success:1};const s=new a({status:{type:Number,required:!0,default:o.pending},resultUrl:{type:String,required:!1},rawResult:{type:String,required:!1},desc:{type:String,required:!0},timeConsuming:{type:String,required:!1}},{timestamps:!0}),i=n.default.model("Task",s);t.Task=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(23),a=r(0);switch(a.default.NAME){case"development":case"production":n.connect(`mongodb://${a.default.DBHOST}:${a.default.DBPORT}/${a.default.DBNAME}`,{useNewUrlParser:!0}).then().catch(e=>console.log(e))}n.connection.once("error",e=>console.error(`mongodb connect error:\n${e}`)).once("open",()=>{console.log("mongodb connect success")}),t.default=n},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("better-xlsx")},function(e,t){e.exports=require("fs")}]);